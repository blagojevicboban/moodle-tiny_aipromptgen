/**
 * EventSource streaming support for the AI Prompt Generator.
 *
 * @package
 * @copyright  2025 AI4Teachers
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("tiny_aipromptgen/stream",["tiny_aipromptgen/markdown"],(function(Markdown){return{startStream:function(findForm,gen,hidden,resp,scrollToResponse){if(!window.EventSource){const form=findForm();return void(form&&form.submit())}const cidEl=document.querySelector("input[name=courseid]"),courseid=cidEl&&cidEl.value||"";hidden.value="ollama";const statusEl=function(resp){let statusEl=document.getElementById("ai-response-status");statusEl||(statusEl=document.createElement("div"),statusEl.id="ai-response-status",statusEl.className="small text-muted",resp&&resp.parentNode&&resp.parentNode.insertBefore(statusEl,resp));const modalStatus=document.getElementById("ai4t-modal-status");modalStatus&&(modalStatus.textContent="Connecting...",modalStatus.style.color="#007bff"),statusEl&&(statusEl.textContent="Streaming...");const modal=document.getElementById("ai4t-airesponse-modal"),backdrop=document.getElementById("ai4t-modal-backdrop");return backdrop&&(backdrop.style.display="block"),modal&&(modal.style.display="block"),resp&&(resp.textContent="",resp.setAttribute("aria-busy","true")),statusEl}(resp),base=(window.M&&window.M.cfg&&window.M.cfg.wwwroot?window.M.cfg.wwwroot:"")+"/lib/editor/tiny/plugins/aipromptgen/stream.php";let prompt=gen.value||gen.textContent||"";if(!prompt){const form=findForm(),fd=new FormData(form||void 0);prompt="Topic: "+(fd.get("topic")||"")+"\nLesson: "+(fd.get("lesson")||"")+"\nOutcomes: "+(fd.get("outcomes")||"")}const es=new EventSource(base+"?courseid="+encodeURIComponent(courseid)+"&provider=ollama&prompt="+encodeURIComponent(prompt));let lastActivity=Date.now();const checkTimeout=setInterval((function(){Date.now()-lastActivity>3e4&&(statusEl&&(statusEl.textContent="Timeout (incomplete)"),resp&&resp.removeAttribute("aria-busy"),es.close(),clearInterval(checkTimeout),scrollToResponse())}),2e3);es.addEventListener("chunk",(function(){lastActivity=Date.now()})),es.addEventListener("done",(function(){clearInterval(checkTimeout)})),es.addEventListener("error",(function(){clearInterval(checkTimeout)})),function(es,resp,statusEl,scrollToResponse){let first=!0;const modalStatus=document.getElementById("ai4t-modal-status");es.addEventListener("start",(function(){statusEl&&(statusEl.textContent="Started"),modalStatus&&(modalStatus.textContent="Receiving..."),scrollToResponse()})),es.addEventListener("chunk",(function(ev){resp&&(resp.textContent+=ev.data,first&&(scrollToResponse(),first=!1)),modalStatus&&(modalStatus.textContent="Receiving...")})),es.addEventListener("error",(function(ev){resp&&(resp.textContent+="\n[Error] "+(ev.data||"")),statusEl&&(statusEl.textContent="Error"),modalStatus&&(modalStatus.textContent="Error occurred",modalStatus.style.color="#dc3545"),scrollToResponse()})),es.addEventListener("done",(function(){statusEl&&(statusEl.textContent="Done"),modalStatus&&(modalStatus.textContent="Finished",modalStatus.style.color="#28a745"),resp&&(resp.removeAttribute("aria-busy"),resp.textContent=Markdown.autofixMarkdown(resp.textContent)),scrollToResponse(),es.close()}))}(es,resp,statusEl,scrollToResponse)}}}));

//# sourceMappingURL=stream.min.js.map