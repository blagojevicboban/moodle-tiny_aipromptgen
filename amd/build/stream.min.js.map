{"version":3,"file":"stream.min.js","sources":["../src/stream.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * EventSource streaming support for the AI Prompt Generator.\n *\n * @package\n * @copyright  2025 AI4Teachers\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['tiny_aipromptgen/markdown'], function(Markdown) {\n\n    const setupStreamingUI = function(resp) {\n        const statusId = 'ai-response-status';\n        let statusEl = document.getElementById(statusId);\n        if (!statusEl) {\n            statusEl = document.createElement('div');\n            statusEl.id = statusId;\n            statusEl.className = 'small text-muted';\n            if (resp && resp.parentNode) {\n                resp.parentNode.insertBefore(statusEl, resp);\n            }\n        }\n\n        const modalStatus = document.getElementById('ai4t-modal-status');\n        if (modalStatus) {\n            modalStatus.textContent = 'Connecting...';\n            modalStatus.style.color = '#007bff';\n        }\n\n        if (statusEl) {\n            statusEl.textContent = 'Streaming...';\n        }\n        const modal = document.getElementById('ai4t-airesponse-modal');\n        const backdrop = document.getElementById('ai4t-modal-backdrop');\n        if (backdrop) {\n            backdrop.style.display = 'block';\n        }\n        if (modal) {\n            modal.style.display = 'block';\n        }\n        if (resp) {\n            resp.textContent = '';\n            resp.setAttribute('aria-busy', 'true');\n        }\n        return statusEl;\n    };\n\n    const attachStreamListeners = function(es, resp, statusEl, scrollToResponse) {\n        let first = true;\n        const modalStatus = document.getElementById('ai4t-modal-status');\n\n        es.addEventListener('start', function() {\n            if (statusEl) {\n                statusEl.textContent = 'Started';\n            }\n            if (modalStatus) {\n                modalStatus.textContent = 'Receiving...';\n            }\n            scrollToResponse();\n        });\n        es.addEventListener('chunk', function(ev) {\n            if (resp) {\n                resp.textContent += ev.data;\n                if (first) {\n                    scrollToResponse();\n                    first = false;\n                }\n            }\n            if (modalStatus) {\n                modalStatus.textContent = 'Receiving...';\n            }\n        });\n        es.addEventListener('error', function(ev) {\n            if (resp) {\n                resp.textContent += '\\n[Error] ' + (ev.data || '');\n            }\n            if (statusEl) {\n                statusEl.textContent = 'Error';\n            }\n            if (modalStatus) {\n                modalStatus.textContent = 'Error occurred';\n                modalStatus.style.color = '#dc3545';\n            }\n            scrollToResponse();\n        });\n        es.addEventListener('done', function() {\n            if (statusEl) {\n                statusEl.textContent = 'Done';\n            }\n            if (modalStatus) {\n                modalStatus.textContent = 'Finished';\n                modalStatus.style.color = '#28a745';\n            }\n            if (resp) {\n                resp.removeAttribute('aria-busy');\n                resp.textContent = Markdown.autofixMarkdown(resp.textContent);\n            }\n            scrollToResponse();\n            es.close();\n        });\n    };\n\n    const startStream = function(findForm, gen, hidden, resp, scrollToResponse) {\n        if (!window.EventSource) {\n            const form = findForm();\n            if (form) {\n                form.submit();\n            }\n            return;\n        }\n\n        const cidEl = document.querySelector('input[name=courseid]');\n        const courseid = (cidEl && cidEl.value) || '';\n        hidden.value = 'ollama';\n\n        const statusEl = setupStreamingUI(resp);\n        const root = (window.M && window.M.cfg && window.M.cfg.wwwroot) ? window.M.cfg.wwwroot : '';\n        const base = root + '/lib/editor/tiny/plugins/aipromptgen/stream.php';\n\n        let prompt = gen.value || gen.textContent || '';\n        if (!prompt) {\n            const form = findForm();\n            const fd = new FormData(form || undefined);\n            prompt = 'Topic: ' + (fd.get('topic') || '') + '\\n' +\n                'Lesson: ' + (fd.get('lesson') || '') + '\\n' +\n                'Outcomes: ' + (fd.get('outcomes') || '');\n        }\n\n        const es = new EventSource(base + '?courseid=' + encodeURIComponent(courseid) +\n            '&provider=ollama&prompt=' + encodeURIComponent(prompt));\n\n        // Timeout logic\n        let lastActivity = Date.now();\n        const timeoutMs = 30000; // 30s timeout\n        const checkTimeout = setInterval(function() {\n            if (Date.now() - lastActivity > timeoutMs) {\n                if (statusEl) {\n                    statusEl.textContent = 'Timeout (incomplete)';\n                }\n                if (resp) {\n                    resp.removeAttribute('aria-busy');\n                }\n                es.close();\n                clearInterval(checkTimeout);\n                scrollToResponse();\n            }\n        }, 2000);\n\n        // Hook into listeners to update lastActivity\n        es.addEventListener('chunk', function() {\n            lastActivity = Date.now();\n        });\n        es.addEventListener('done', function() {\n            clearInterval(checkTimeout);\n        });\n        es.addEventListener('error', function() {\n            clearInterval(checkTimeout);\n        });\n\n        attachStreamListeners(es, resp, statusEl, scrollToResponse);\n    };\n\n    return {\n        startStream: startStream\n    };\n});\n"],"names":["define","Markdown","startStream","findForm","gen","hidden","resp","scrollToResponse","window","EventSource","form","submit","cidEl","document","querySelector","courseid","value","statusEl","getElementById","createElement","id","className","parentNode","insertBefore","modalStatus","textContent","style","color","modal","backdrop","display","setAttribute","setupStreamingUI","base","M","cfg","wwwroot","prompt","fd","FormData","undefined","get","es","encodeURIComponent","lastActivity","Date","now","checkTimeout","setInterval","removeAttribute","close","clearInterval","addEventListener","first","ev","data","autofixMarkdown","attachStreamListeners"],"mappings":";;;;;;;AAyBAA,iCAAO,CAAC,8BAA8B,SAASC,gBAyJpC,CACHC,YA7DgB,SAASC,SAAUC,IAAKC,OAAQC,KAAMC,sBACjDC,OAAOC,YAAa,OACfC,KAAOP,uBACTO,MACAA,KAAKC,gBAKPC,MAAQC,SAASC,cAAc,wBAC/BC,SAAYH,OAASA,MAAMI,OAAU,GAC3CX,OAAOW,MAAQ,eAETC,SAxGe,SAASX,UAE1BW,SAAWJ,SAASK,eADP,sBAEZD,WACDA,SAAWJ,SAASM,cAAc,OAClCF,SAASG,GAJI,qBAKbH,SAASI,UAAY,mBACjBf,MAAQA,KAAKgB,YACbhB,KAAKgB,WAAWC,aAAaN,SAAUX,aAIzCkB,YAAcX,SAASK,eAAe,qBACxCM,cACAA,YAAYC,YAAc,gBAC1BD,YAAYE,MAAMC,MAAQ,WAG1BV,WACAA,SAASQ,YAAc,sBAErBG,MAAQf,SAASK,eAAe,yBAChCW,SAAWhB,SAASK,eAAe,8BACrCW,WACAA,SAASH,MAAMI,QAAU,SAEzBF,QACAA,MAAMF,MAAMI,QAAU,SAEtBxB,OACAA,KAAKmB,YAAc,GACnBnB,KAAKyB,aAAa,YAAa,SAE5Bd,SAuEUe,CAAiB1B,MAE5B2B,MADQzB,OAAO0B,GAAK1B,OAAO0B,EAAEC,KAAO3B,OAAO0B,EAAEC,IAAIC,QAAW5B,OAAO0B,EAAEC,IAAIC,QAAU,IACrE,sDAEhBC,OAASjC,IAAIY,OAASZ,IAAIqB,aAAe,OACxCY,OAAQ,OACH3B,KAAOP,WACPmC,GAAK,IAAIC,SAAS7B,WAAQ8B,GAChCH,OAAS,WAAaC,GAAGG,IAAI,UAAY,IAAhC,cACSH,GAAGG,IAAI,WAAa,IAD7B,gBAEWH,GAAGG,IAAI,aAAe,UAGxCC,GAAK,IAAIjC,YAAYwB,KAAO,aAAeU,mBAAmB5B,UAChE,2BAA6B4B,mBAAmBN,aAGhDO,aAAeC,KAAKC,YAElBC,aAAeC,aAAY,WACzBH,KAAKC,MAAQF,aAFH,MAGN3B,WACAA,SAASQ,YAAc,wBAEvBnB,MACAA,KAAK2C,gBAAgB,aAEzBP,GAAGQ,QACHC,cAAcJ,cACdxC,sBAEL,KAGHmC,GAAGU,iBAAiB,SAAS,WACzBR,aAAeC,KAAKC,SAExBJ,GAAGU,iBAAiB,QAAQ,WACxBD,cAAcJ,iBAElBL,GAAGU,iBAAiB,SAAS,WACzBD,cAAcJ,iBA7GQ,SAASL,GAAIpC,KAAMW,SAAUV,sBACnD8C,OAAQ,QACN7B,YAAcX,SAASK,eAAe,qBAE5CwB,GAAGU,iBAAiB,SAAS,WACrBnC,WACAA,SAASQ,YAAc,WAEvBD,cACAA,YAAYC,YAAc,gBAE9BlB,sBAEJmC,GAAGU,iBAAiB,SAAS,SAASE,IAC9BhD,OACAA,KAAKmB,aAAe6B,GAAGC,KACnBF,QACA9C,mBACA8C,OAAQ,IAGZ7B,cACAA,YAAYC,YAAc,mBAGlCiB,GAAGU,iBAAiB,SAAS,SAASE,IAC9BhD,OACAA,KAAKmB,aAAe,cAAgB6B,GAAGC,MAAQ,KAE/CtC,WACAA,SAASQ,YAAc,SAEvBD,cACAA,YAAYC,YAAc,iBAC1BD,YAAYE,MAAMC,MAAQ,WAE9BpB,sBAEJmC,GAAGU,iBAAiB,QAAQ,WACpBnC,WACAA,SAASQ,YAAc,QAEvBD,cACAA,YAAYC,YAAc,WAC1BD,YAAYE,MAAMC,MAAQ,WAE1BrB,OACAA,KAAK2C,gBAAgB,aACrB3C,KAAKmB,YAAcxB,SAASuD,gBAAgBlD,KAAKmB,cAErDlB,mBACAmC,GAAGQ,WA6DPO,CAAsBf,GAAIpC,KAAMW,SAAUV"}