{"version":3,"file":"stream.min.js","sources":["../src/stream.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * EventSource streaming support for the AI Prompt Generator.\n *\n * @package\n * @copyright  2025 AI4Teachers\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/str', 'tiny_aipromptgen/markdown'], function(Str, Markdown) {\n\n    const updateElText = function(el, stringId) {\n        if (!el) {\n            return;\n        }\n        Str.get_string(stringId, 'tiny_aipromptgen').then(function(s) {\n            el.textContent = s;\n            return s;\n        }).catch(function() {\n            // Silent fail.\n        });\n    };\n\n    const setupStreamingUI = function(resp) {\n        const statusId = 'ai-response-status';\n        let statusEl = document.getElementById(statusId);\n        if (!statusEl) {\n            statusEl = document.createElement('div');\n            statusEl.id = statusId;\n            statusEl.className = 'small text-muted';\n            if (resp && resp.parentNode) {\n                resp.parentNode.insertBefore(statusEl, resp);\n            }\n        }\n\n        const modalStatus = document.getElementById('ai4t-modal-status');\n        if (modalStatus) {\n            updateElText(modalStatus, 'status_connecting');\n            modalStatus.style.color = '#007bff';\n        }\n\n        if (statusEl) {\n            updateElText(statusEl, 'status_streaming');\n        }\n        const modal = document.getElementById('ai4t-airesponse-modal');\n        const backdrop = document.getElementById('ai4t-modal-backdrop');\n        if (backdrop) {\n            backdrop.style.display = 'block';\n        }\n        if (modal) {\n            modal.style.display = 'block';\n        }\n        if (resp) {\n            resp.textContent = '';\n            resp.setAttribute('aria-busy', 'true');\n        }\n        return statusEl;\n    };\n\n    const attachStreamListeners = function(es, resp, statusEl, scrollToResponse) {\n        let first = true;\n        const modalStatus = document.getElementById('ai4t-modal-status');\n\n        es.addEventListener('start', function() {\n            updateElText(statusEl, 'status_started');\n            updateElText(modalStatus, 'status_receiving');\n            scrollToResponse();\n        });\n        es.addEventListener('chunk', function(ev) {\n            if (resp) {\n                resp.textContent += ev.data;\n                if (first) {\n                    scrollToResponse();\n                    first = false;\n                }\n            }\n            updateElText(modalStatus, 'status_receiving');\n        });\n        es.addEventListener('error', function(ev) {\n            if (resp) {\n                Str.get_string('status_error', 'tiny_aipromptgen').then(function(s) {\n                    resp.textContent += '\\n[' + s + '] ' + (ev.data || '');\n                    return s;\n                }).catch(function() {\n                    resp.textContent += '\\n[Error] ' + (ev.data || '');\n                });\n            }\n            updateElText(statusEl, 'status_error');\n            if (modalStatus) {\n                updateElText(modalStatus, 'status_error_occurred');\n                modalStatus.style.color = '#dc3545';\n            }\n            scrollToResponse();\n        });\n        es.addEventListener('done', function() {\n            updateElText(statusEl, 'status_done');\n            if (modalStatus) {\n                updateElText(modalStatus, 'status_finished');\n                modalStatus.style.color = '#28a745';\n            }\n            if (resp) {\n                resp.removeAttribute('aria-busy');\n                resp.textContent = Markdown.autofixMarkdown(resp.textContent);\n            }\n            scrollToResponse();\n            es.close();\n        });\n    };\n\n    const startStream = function(findForm, gen, hidden, resp, scrollToResponse) {\n        if (!window.EventSource) {\n            const form = findForm();\n            if (form) {\n                form.submit();\n            }\n            return;\n        }\n\n        const cidEl = document.querySelector('input[name=courseid]');\n        const courseid = (cidEl && cidEl.value) || '';\n        hidden.value = 'ollama';\n\n        const statusEl = setupStreamingUI(resp);\n        const root = (window.M && window.M.cfg && window.M.cfg.wwwroot) ? window.M.cfg.wwwroot : '';\n        const base = root + '/lib/editor/tiny/plugins/aipromptgen/stream.php';\n\n        let prompt = gen.value || gen.textContent || '';\n        if (!prompt) {\n            const form = findForm();\n            const fd = new FormData(form || undefined);\n            prompt = 'Topic: ' + (fd.get('topic') || '') + '\\n' +\n                'Lesson: ' + (fd.get('lesson') || '') + '\\n' +\n                'Outcomes: ' + (fd.get('outcomes') || '');\n        }\n\n        const es = new EventSource(base + '?courseid=' + encodeURIComponent(courseid) +\n            '&provider=ollama&prompt=' + encodeURIComponent(prompt));\n\n        // Timeout logic\n        let lastActivity = Date.now();\n        const timeoutMs = 30000; // 30s timeout\n        const checkTimeout = setInterval(function() {\n            if (Date.now() - lastActivity > timeoutMs) {\n                updateElText(statusEl, 'status_timeout');\n                if (resp) {\n                    resp.removeAttribute('aria-busy');\n                }\n                es.close();\n                clearInterval(checkTimeout);\n                scrollToResponse();\n            }\n        }, 2000);\n\n        // Hook into listeners to update lastActivity\n        es.addEventListener('chunk', function() {\n            lastActivity = Date.now();\n        });\n        es.addEventListener('done', function() {\n            clearInterval(checkTimeout);\n        });\n        es.addEventListener('error', function() {\n            clearInterval(checkTimeout);\n        });\n\n        attachStreamListeners(es, resp, statusEl, scrollToResponse);\n    };\n\n    return {\n        startStream: startStream\n    };\n});\n"],"names":["define","Str","Markdown","updateElText","el","stringId","get_string","then","s","textContent","catch","startStream","findForm","gen","hidden","resp","scrollToResponse","window","EventSource","form","submit","cidEl","document","querySelector","courseid","value","statusEl","getElementById","createElement","id","className","parentNode","insertBefore","modalStatus","style","color","modal","backdrop","display","setAttribute","setupStreamingUI","base","M","cfg","wwwroot","prompt","fd","FormData","undefined","get","es","encodeURIComponent","lastActivity","Date","now","checkTimeout","setInterval","removeAttribute","close","clearInterval","addEventListener","first","ev","data","autofixMarkdown","attachStreamListeners"],"mappings":"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"}