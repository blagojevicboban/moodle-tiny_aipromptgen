{"version":3,"file":"stream.min.js","sources":["../src/stream.js"],"sourcesContent":["define(['tiny_aipromptgen/markdown'], function(Markdown) {\n\n    const setupStreamingUI = function(resp) {\n        const statusId = 'ai-response-status';\n        let statusEl = document.getElementById(statusId);\n        if (!statusEl) {\n            statusEl = document.createElement('div');\n            statusEl.id = statusId;\n            statusEl.className = 'small text-muted';\n            if (resp && resp.parentNode) {\n                resp.parentNode.insertBefore(statusEl, resp);\n            }\n        }\n        if (statusEl) {\n            statusEl.textContent = 'Streaming...';\n        }\n        const modal = document.getElementById('ai4t-airesponse-modal');\n        const backdrop = document.getElementById('ai4t-modal-backdrop');\n        if (backdrop) {\n            backdrop.style.display = 'block';\n        }\n        if (modal) {\n            modal.style.display = 'block';\n        }\n        if (resp) {\n            resp.textContent = '';\n            resp.setAttribute('aria-busy', 'true');\n        }\n        return statusEl;\n    };\n\n    const attachStreamListeners = function(es, resp, statusEl, scrollToResponse) {\n        let first = true;\n        es.addEventListener('start', function() {\n            if (statusEl) {\n                statusEl.textContent = 'Started';\n            }\n            scrollToResponse();\n        });\n        es.addEventListener('chunk', function(ev) {\n            if (resp) {\n                resp.textContent += ev.data;\n                if (first) {\n                    scrollToResponse();\n                    first = false;\n                }\n            }\n        });\n        es.addEventListener('error', function(ev) {\n            if (resp) {\n                resp.textContent += '\\n[Error] ' + (ev.data || '');\n            }\n            if (statusEl) {\n                statusEl.textContent = 'Error';\n            }\n            scrollToResponse();\n        });\n        es.addEventListener('done', function() {\n            if (statusEl) {\n                statusEl.textContent = 'Done';\n            }\n            if (resp) {\n                resp.removeAttribute('aria-busy');\n                resp.textContent = Markdown.autofixMarkdown(resp.textContent);\n            }\n            scrollToResponse();\n            es.close();\n        });\n    };\n\n    const startStream = function(findForm, gen, hidden, resp, scrollToResponse) {\n        if (!window.EventSource) {\n            const form = findForm();\n            if (form) {\n                form.submit();\n            }\n            return;\n        }\n\n        const cidEl = document.querySelector('input[name=courseid]');\n        const courseid = (cidEl && cidEl.value) || '';\n        hidden.value = 'ollama';\n\n        const statusEl = setupStreamingUI(resp);\n        const root = (window.M && window.M.cfg && window.M.cfg.wwwroot) ? window.M.cfg.wwwroot : '';\n        const base = root + '/lib/editor/tiny/plugins/aipromptgen/stream.php';\n\n        let prompt = gen.value || gen.textContent || '';\n        if (!prompt) {\n            const form = findForm();\n            const fd = new FormData(form || undefined);\n            prompt = 'Topic: ' + (fd.get('topic') || '') + '\\n' +\n                'Lesson: ' + (fd.get('lesson') || '') + '\\n' +\n                'Outcomes: ' + (fd.get('outcomes') || '');\n        }\n\n        const es = new EventSource(base + '?courseid=' + encodeURIComponent(courseid) +\n            '&provider=ollama&prompt=' + encodeURIComponent(prompt));\n\n        // Timeout logic\n        let lastActivity = Date.now();\n        const timeoutMs = 30000; // 30s timeout\n        const checkTimeout = setInterval(function() {\n            if (Date.now() - lastActivity > timeoutMs) {\n                if (statusEl) {\n                    statusEl.textContent = 'Timeout (incomplete)';\n                }\n                if (resp) {\n                    resp.removeAttribute('aria-busy');\n                }\n                es.close();\n                clearInterval(checkTimeout);\n                scrollToResponse();\n            }\n        }, 2000);\n\n        // Hook into listeners to update lastActivity\n        es.addEventListener('chunk', function() {\n            lastActivity = Date.now();\n        });\n        es.addEventListener('done', function() {\n            clearInterval(checkTimeout);\n        });\n        es.addEventListener('error', function() {\n            clearInterval(checkTimeout);\n        });\n\n        attachStreamListeners(es, resp, statusEl, scrollToResponse);\n    };\n\n    return {\n        startStream: startStream\n    };\n});\n"],"names":["define","Markdown","startStream","findForm","gen","hidden","resp","scrollToResponse","window","EventSource","form","submit","cidEl","document","querySelector","courseid","value","statusEl","getElementById","createElement","id","className","parentNode","insertBefore","textContent","modal","backdrop","style","display","setAttribute","setupStreamingUI","base","M","cfg","wwwroot","prompt","fd","FormData","undefined","get","es","encodeURIComponent","lastActivity","Date","now","checkTimeout","setInterval","removeAttribute","close","clearInterval","addEventListener","first","ev","data","autofixMarkdown","attachStreamListeners"],"mappings":"AAAAA,iCAAO,CAAC,8BAA8B,SAASC,gBAkIpC,CACHC,YA7DgB,SAASC,SAAUC,IAAKC,OAAQC,KAAMC,sBACjDC,OAAOC,YAAa,OACfC,KAAOP,uBACTO,MACAA,KAAKC,gBAKPC,MAAQC,SAASC,cAAc,wBAC/BC,SAAYH,OAASA,MAAMI,OAAU,GAC3CX,OAAOW,MAAQ,eAETC,SAjFe,SAASX,UAE1BW,SAAWJ,SAASK,eADP,sBAEZD,WACDA,SAAWJ,SAASM,cAAc,OAClCF,SAASG,GAJI,qBAKbH,SAASI,UAAY,mBACjBf,MAAQA,KAAKgB,YACbhB,KAAKgB,WAAWC,aAAaN,SAAUX,OAG3CW,WACAA,SAASO,YAAc,sBAErBC,MAAQZ,SAASK,eAAe,yBAChCQ,SAAWb,SAASK,eAAe,8BACrCQ,WACAA,SAASC,MAAMC,QAAU,SAEzBH,QACAA,MAAME,MAAMC,QAAU,SAEtBtB,OACAA,KAAKkB,YAAc,GACnBlB,KAAKuB,aAAa,YAAa,SAE5BZ,SAuDUa,CAAiBxB,MAE5ByB,MADQvB,OAAOwB,GAAKxB,OAAOwB,EAAEC,KAAOzB,OAAOwB,EAAEC,IAAIC,QAAW1B,OAAOwB,EAAEC,IAAIC,QAAU,IACrE,sDAEhBC,OAAS/B,IAAIY,OAASZ,IAAIoB,aAAe,OACxCW,OAAQ,OACHzB,KAAOP,WACPiC,GAAK,IAAIC,SAAS3B,WAAQ4B,GAChCH,OAAS,WAAaC,GAAGG,IAAI,UAAY,IAAhC,cACSH,GAAGG,IAAI,WAAa,IAD7B,gBAEWH,GAAGG,IAAI,aAAe,UAGxCC,GAAK,IAAI/B,YAAYsB,KAAO,aAAeU,mBAAmB1B,UAChE,2BAA6B0B,mBAAmBN,aAGhDO,aAAeC,KAAKC,YAElBC,aAAeC,aAAY,WACzBH,KAAKC,MAAQF,aAFH,MAGNzB,WACAA,SAASO,YAAc,wBAEvBlB,MACAA,KAAKyC,gBAAgB,aAEzBP,GAAGQ,QACHC,cAAcJ,cACdtC,sBAEL,KAGHiC,GAAGU,iBAAiB,SAAS,WACzBR,aAAeC,KAAKC,SAExBJ,GAAGU,iBAAiB,QAAQ,WACxBD,cAAcJ,iBAElBL,GAAGU,iBAAiB,SAAS,WACzBD,cAAcJ,iBA7FQ,SAASL,GAAIlC,KAAMW,SAAUV,sBACnD4C,OAAQ,EACZX,GAAGU,iBAAiB,SAAS,WACrBjC,WACAA,SAASO,YAAc,WAE3BjB,sBAEJiC,GAAGU,iBAAiB,SAAS,SAASE,IAC9B9C,OACAA,KAAKkB,aAAe4B,GAAGC,KACnBF,QACA5C,mBACA4C,OAAQ,OAIpBX,GAAGU,iBAAiB,SAAS,SAASE,IAC9B9C,OACAA,KAAKkB,aAAe,cAAgB4B,GAAGC,MAAQ,KAE/CpC,WACAA,SAASO,YAAc,SAE3BjB,sBAEJiC,GAAGU,iBAAiB,QAAQ,WACpBjC,WACAA,SAASO,YAAc,QAEvBlB,OACAA,KAAKyC,gBAAgB,aACrBzC,KAAKkB,YAAcvB,SAASqD,gBAAgBhD,KAAKkB,cAErDjB,mBACAiC,GAAGQ,WA6DPO,CAAsBf,GAAIlC,KAAMW,SAAUV"}