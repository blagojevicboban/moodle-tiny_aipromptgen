{"version":3,"file":"plugin.min.js","sources":["../src/plugin.js"],"sourcesContent":["\nimport {getTinyMCE} from 'editor_tiny/loader';\nimport {getPluginMetadata} from 'editor_tiny/utils';\nimport * as Configuration from './configuration';\n\nexport default Promise.all([\n    getTinyMCE(),\n    getPluginMetadata('tiny_aipromptgen', 'tiny_aipromptgen/plugin'),\n]).then(([tinyMCE, pluginMetadata]) => {\n    tinyMCE.PluginManager.add('tiny_aipromptgen/plugin', (editor) => {\n        // Register the icon with a unique name\n        // eslint-disable-next-line max-len\n        editor.ui.registry.addIcon('tiny-aipromptgen-icon', '<svg width=\"24\" height=\"24\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"11\" width=\"18\" height=\"10\" rx=\"2\"></rect><circle cx=\"12\" cy=\"5\" r=\"2\"></circle><path d=\"M12 7v4\"></path><circle cx=\"8\" cy=\"16\" r=\"1.5\" fill=\"white\" stroke=\"none\"></circle><circle cx=\"16\" cy=\"16\" r=\"1.5\" fill=\"white\" stroke=\"none\"></circle></svg>');\n\n        /**\n         * Get the course ID from various sources.\n         * @returns {string}\n         */\n        const getCourseId = () => {\n            let courseId = '1';\n            const urlParams = new URLSearchParams(window.location.search);\n\n            if (urlParams.has('courseid')) {\n                courseId = urlParams.get('courseid');\n            } else if (urlParams.has('id')) {\n                if (window.location.href.indexOf('/course/view.php') !== -1) {\n                    courseId = urlParams.get('id');\n                } else {\n                    const link = document.querySelector('a[href*=\"/course/view.php?id=\"]');\n                    if (link) {\n                        const m = link.href.match(/id=(\\d+)/);\n                        if (m) {\n                            courseId = m[1];\n                        }\n                    }\n                }\n            }\n\n            if (window.M && window.M.cfg && window.M.cfg.courseId && window.M.cfg.courseId != 1) {\n                courseId = window.M.cfg.courseId;\n            }\n\n            if (courseId === '1') {\n                const cInput = document.querySelector('input[name=\"course\"]');\n                if (cInput) {\n                    courseId = cInput.value;\n                }\n            }\n            return courseId;\n        };\n\n        /**\n         * Get context (topic and lesson) from the page.\n         * @returns {Object}\n         */\n        const getContext = () => {\n            let topic = '';\n            let lesson = '';\n            const skipList = ['settings', 'general', 'more', 'administration', 'courses', 'home', 'edit'];\n\n            if (window.location.href.indexOf('editsection.php') !== -1 || window.location.href.indexOf('section.php') !== -1) {\n                const topicInput = document.getElementById('id_name') || document.querySelector('input[name=\"name\"]');\n                if (topicInput) {\n                    topic = topicInput.value;\n                }\n            } else {\n                const nameInput = document.querySelector('input[name=\"name\"]') || document.getElementById('id_name');\n                if (nameInput) {\n                    lesson = nameInput.value;\n                }\n\n                const sectionInput = document.getElementById('id_name_value') || document.getElementById('id_sectionname');\n                if (sectionInput && sectionInput.value) {\n                    topic = sectionInput.value;\n                } else {\n                    const breadcrumbs = document.querySelectorAll('.breadcrumb-item');\n                    for (let i = breadcrumbs.length - 1; i >= 0 && !topic; i--) {\n                        const text = breadcrumbs[i].textContent.trim();\n                        const lowerText = text.toLowerCase();\n                        const isSkip = skipList.some(s => lowerText.indexOf(s) !== -1);\n                        if (text && text !== lesson && !isSkip) {\n                            topic = text;\n                        }\n                    }\n\n                    if (!topic) {\n                        const sectionNameEl = document.querySelector('.sectionname') ||\n                                          document.querySelector('.page-header-headings h1') ||\n                                          document.querySelector('.course-section .section-name');\n                        if (sectionNameEl) {\n                            const stext = sectionNameEl.textContent.trim();\n                            if (stext !== lesson) {\n                                topic = stext;\n                            }\n                        }\n                    }\n                }\n            }\n            return {topic, lesson};\n        };\n\n        const openPromptGenerator = function() {\n            const courseId = getCourseId();\n            const {topic, lesson} = getContext();\n\n            const width = 900;\n            const height = 800;\n            const left = (screen.width - width) / 2;\n            const top = (screen.height - height) / 2;\n\n            // eslint-disable-next-line max-len\n            const url = (window.M && window.M.cfg && window.M.cfg.wwwroot ? window.M.cfg.wwwroot : '') + '/lib/editor/tiny/plugins/aipromptgen/view.php?courseid=' + courseId + '&topic=' + encodeURIComponent(topic) + '&lesson=' + encodeURIComponent(lesson) + '&popup=1';\n\n            // eslint-disable-next-line max-len\n            window.open(url, 'aipromptgen_popup', 'width=' + width + ',height=' + height + ',top=' + top + ',left=' + left + ',scrollbars=yes,resizable=yes');\n        };\n\n        // Register the button\n        editor.ui.registry.addButton('tiny_aipromptgen', {\n            icon: 'tiny-aipromptgen-icon',\n            tooltip: 'AI Prompt Generator',\n            onAction: openPromptGenerator\n        });\n\n        // Register the menu item\n        editor.ui.registry.addMenuItem('tiny_aipromptgen', {\n            text: 'AI Prompt Generator',\n            icon: 'tiny-aipromptgen-icon',\n            onAction: openPromptGenerator\n        });\n\n        return pluginMetadata;\n    });\n\n    return ['tiny_aipromptgen/plugin', Configuration];\n});\n"],"names":["Promise","all","then","_ref","tinyMCE","pluginMetadata","PluginManager","add","editor","ui","registry","addIcon","openPromptGenerator","courseId","urlParams","URLSearchParams","window","location","search","has","get","href","indexOf","link","document","querySelector","m","match","M","cfg","cInput","value","getCourseId","topic","lesson","skipList","topicInput","getElementById","nameInput","sectionInput","breadcrumbs","querySelectorAll","i","length","text","textContent","trim","lowerText","toLowerCase","isSkip","some","s","sectionNameEl","stext","getContext","left","screen","width","top","height","url","wwwroot","encodeURIComponent","open","addButton","icon","tooltip","onAction","addMenuItem","Configuration"],"mappings":"mrCAKeA,QAAQC,IAAI,EACvB,yBACA,4BAAkB,mBAAoB,6BACvCC,MAAKC,WAAEC,QAASC,4BACfD,QAAQE,cAAcC,IAAI,2BAA4BC,SAGlDA,OAAOC,GAAGC,SAASC,QAAQ,wBAAyB,mcAyF9CC,oBAAsB,iBAClBC,SApFU,UACZA,SAAW,UACTC,UAAY,IAAIC,gBAAgBC,OAAOC,SAASC,WAElDJ,UAAUK,IAAI,YACdN,SAAWC,UAAUM,IAAI,iBACtB,GAAIN,UAAUK,IAAI,UACqC,IAAtDH,OAAOC,SAASI,KAAKC,QAAQ,oBAC7BT,SAAWC,UAAUM,IAAI,UACtB,OACGG,KAAOC,SAASC,cAAc,sCAChCF,KAAM,OACAG,EAAIH,KAAKF,KAAKM,MAAM,YACtBD,IACAb,SAAWa,EAAE,QAMzBV,OAAOY,GAAKZ,OAAOY,EAAEC,KAAOb,OAAOY,EAAEC,IAAIhB,UAAqC,GAAzBG,OAAOY,EAAEC,IAAIhB,WAClEA,SAAWG,OAAOY,EAAEC,IAAIhB,UAGX,MAAbA,SAAkB,OACZiB,OAASN,SAASC,cAAc,wBAClCK,SACAjB,SAAWiB,OAAOC,cAGnBlB,UAsDUmB,IACXC,MAACA,MAADC,OAAQA,QAhDC,UACXD,MAAQ,GACRC,OAAS,SACPC,SAAW,CAAC,WAAY,UAAW,OAAQ,iBAAkB,UAAW,OAAQ,YAE7B,IAArDnB,OAAOC,SAASI,KAAKC,QAAQ,qBAA8E,IAAjDN,OAAOC,SAASI,KAAKC,QAAQ,eAAuB,OACxGc,WAAaZ,SAASa,eAAe,YAAcb,SAASC,cAAc,sBAC5EW,aACAH,MAAQG,WAAWL,WAEpB,OACGO,UAAYd,SAASC,cAAc,uBAAyBD,SAASa,eAAe,WACtFC,YACAJ,OAASI,UAAUP,aAGjBQ,aAAef,SAASa,eAAe,kBAAoBb,SAASa,eAAe,qBACrFE,cAAgBA,aAAaR,MAC7BE,MAAQM,aAAaR,UAClB,OACGS,YAAchB,SAASiB,iBAAiB,wBACzC,IAAIC,EAAIF,YAAYG,OAAS,EAAGD,GAAK,IAAMT,MAAOS,IAAK,OAClDE,KAAOJ,YAAYE,GAAGG,YAAYC,OAClCC,UAAYH,KAAKI,cACjBC,OAASd,SAASe,MAAKC,IAA+B,IAA1BJ,UAAUzB,QAAQ6B,KAChDP,MAAQA,OAASV,SAAWe,SAC5BhB,MAAQW,UAIXX,MAAO,OACFmB,cAAgB5B,SAASC,cAAc,iBAC3BD,SAASC,cAAc,6BACvBD,SAASC,cAAc,oCACrC2B,cAAe,OACTC,MAAQD,cAAcP,YAAYC,OACpCO,QAAUnB,SACVD,MAAQoB,gBAMrB,CAACpB,MAAAA,MAAOC,OAAAA,SAKSoB,GAIlBC,MAAQC,OAAOC,MAFP,KAEwB,EAChCC,KAAOF,OAAOG,OAFL,KAEwB,EAGjCC,KAAO5C,OAAOY,GAAKZ,OAAOY,EAAEC,KAAOb,OAAOY,EAAEC,IAAIgC,QAAU7C,OAAOY,EAAEC,IAAIgC,QAAU,IAAM,0DAA4DhD,SAAW,UAAYiD,mBAAmB7B,OAAS,WAAa6B,mBAAmB5B,QAAU,WAGtPlB,OAAO+C,KAAKH,IAAK,oBAAqB,4BAAmDF,IAAM,SAAWH,KAAO,yCAIrH/C,OAAOC,GAAGC,SAASsD,UAAU,mBAAoB,CAC7CC,KAAM,wBACNC,QAAS,sBACTC,SAAUvD,sBAIdJ,OAAOC,GAAGC,SAAS0D,YAAY,mBAAoB,CAC/CxB,KAAM,sBACNqB,KAAM,wBACNE,SAAUvD,sBAGPP,kBAGJ,CAAC,0BAA2BgE"}