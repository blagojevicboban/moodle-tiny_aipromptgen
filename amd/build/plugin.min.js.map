{"version":3,"file":"plugin.min.js","sources":["../src/plugin.js"],"sourcesContent":["\nimport {getTinyMCE} from 'editor_tiny/loader';\nimport {getPluginMetadata} from 'editor_tiny/utils';\nimport * as Configuration from './configuration';\n\nexport default Promise.all([\n    getTinyMCE(),\n    getPluginMetadata('tiny_aipromptgen', 'tiny_aipromptgen/plugin'),\n]).then(([tinyMCE, pluginMetadata]) => {\n    tinyMCE.PluginManager.add('tiny_aipromptgen/plugin', (editor) => {\n        // Register the icon with a unique name\n        // eslint-disable-next-line max-len\n        editor.ui.registry.addIcon('tiny-aipromptgen-icon', '<svg width=\"24\" height=\"24\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"3\" y=\"11\" width=\"18\" height=\"10\" rx=\"2\"></rect><circle cx=\"12\" cy=\"5\" r=\"2\"></circle><path d=\"M12 7v4\"></path><circle cx=\"8\" cy=\"16\" r=\"1.5\" fill=\"white\" stroke=\"none\"></circle><circle cx=\"16\" cy=\"16\" r=\"1.5\" fill=\"white\" stroke=\"none\"></circle></svg>');\n\n        var openPromptGenerator = function() {\n            var courseId = '1';\n\n            var urlParams = new URLSearchParams(window.location.search);\n            if (urlParams.has('courseid')) {\n                courseId = urlParams.get('courseid');\n            } else if (urlParams.has('id')) {\n                if (window.location.href.indexOf('/course/view.php') !== -1) {\n                    courseId = urlParams.get('id');\n                } else {\n                    var link = document.querySelector('a[href*=\"/course/view.php?id=\"]');\n                    if (link) {\n                        var m = link.href.match(/id=(\\d+)/);\n                        if (m) {\n                            courseId = m[1];\n                        }\n                    }\n                }\n            }\n\n            if (window.M && window.M.cfg && window.M.cfg.courseId && window.M.cfg.courseId != 1) {\n                courseId = window.M.cfg.courseId;\n            }\n\n            if (courseId === '1') {\n                var cInput = document.querySelector('input[name=\"course\"]');\n                if (cInput) {\n                    courseId = cInput.value;\n                }\n            }\n\n            var width = 900;\n            var height = 800;\n            var left = (screen.width - width) / 2;\n            var top = (screen.height - height) / 2;\n\n            // Context Extraction\n            var topic = '';\n            var lesson = '';\n\n            if (window.location.href.indexOf('editsection.php') !== -1 || window.location.href.indexOf('section.php') !== -1) {\n                // Editing a section: 'id_name' is the topic name.\n                var topicInput = document.getElementById('id_name') || document.querySelector('input[name=\"name\"]');\n                if (topicInput) {\n                    topic = topicInput.value;\n                }\n            } else {\n                // Editing an activity or other content: 'id_name' is the lesson title.\n                var nameInput = document.querySelector('input[name=\"name\"]') || document.getElementById('id_name');\n                if (nameInput) {\n                    lesson = nameInput.value;\n                }\n\n                // Try to find section (Topic) name.\n                var sectionInput = document.getElementById('id_name_value') || document.getElementById('id_sectionname');\n                if (sectionInput && sectionInput.value) {\n                    topic = sectionInput.value;\n                } else {\n                    // Fallback to breadcrumbs.\n                    var breadcrumbs = document.querySelectorAll('.breadcrumb-item');\n                    if (breadcrumbs.length > 2) {\n                        // We want to find the first breadcrumb from the end that isn't\n                        // the current \"lesson\" (activity) name or \"Edit\" or common UI words.\n                        var skipList = ['settings', 'general', 'more', 'administration', 'courses', 'home', 'edit'];\n                        for (var i = breadcrumbs.length - 1; i >= 0; i--) {\n                            var text = breadcrumbs[i].textContent.trim();\n                            var lowerText = text.toLowerCase();\n                            var skip = false;\n                            for (var j = 0; j < skipList.length; j++) {\n                                if (lowerText.indexOf(skipList[j]) !== -1) {\n                                    skip = true;\n                                    break;\n                                }\n                            }\n                            if (text && text !== lesson && !skip) {\n                                topic = text;\n                                break;\n                            }\n                        }\n                    }\n                    if (!topic) {\n                        // Try finding element with class sectionname or similar.\n                        var sectionNameEl = document.querySelector('.sectionname') ||\n                                          document.querySelector('.page-header-headings h1') ||\n                                          document.querySelector('.course-section .section-name');\n                        if (sectionNameEl) {\n                            var stext = sectionNameEl.textContent.trim();\n                            if (stext !== lesson) {\n                                topic = stext;\n                            }\n                        }\n                    }\n                }\n            }\n\n            // eslint-disable-next-line max-len\n            var url = (window.M && window.M.cfg && window.M.cfg.wwwroot ? window.M.cfg.wwwroot : '') + '/lib/editor/tiny/plugins/aipromptgen/view.php?courseid=' + courseId + '&topic=' + encodeURIComponent(topic) + '&lesson=' + encodeURIComponent(lesson) + '&popup=1';\n\n            // eslint-disable-next-line max-len\n            window.open(url, 'aipromptgen_popup', 'width=' + width + ',height=' + height + ',top=' + top + ',left=' + left + ',scrollbars=yes,resizable=yes');\n        };\n\n        // Register the button\n        editor.ui.registry.addButton('tiny_aipromptgen', {\n            icon: 'tiny-aipromptgen-icon',\n            tooltip: 'AI Prompt Generator',\n            onAction: openPromptGenerator\n        });\n\n        // Register the menu item\n        editor.ui.registry.addMenuItem('tiny_aipromptgen', {\n            text: 'AI Prompt Generator',\n            icon: 'tiny-aipromptgen-icon',\n            onAction: openPromptGenerator\n        });\n\n        return pluginMetadata;\n    });\n\n    return ['tiny_aipromptgen/plugin', Configuration];\n});\n"],"names":["Promise","all","then","_ref","tinyMCE","pluginMetadata","PluginManager","add","editor","ui","registry","addIcon","openPromptGenerator","courseId","urlParams","URLSearchParams","window","location","search","has","get","href","indexOf","link","document","querySelector","m","match","M","cfg","cInput","value","left","screen","width","top","height","topic","lesson","topicInput","getElementById","nameInput","sectionInput","breadcrumbs","querySelectorAll","length","skipList","i","text","textContent","trim","lowerText","toLowerCase","skip","j","sectionNameEl","stext","url","wwwroot","encodeURIComponent","open","addButton","icon","tooltip","onAction","addMenuItem","Configuration"],"mappings":"mrCAKeA,QAAQC,IAAI,EACvB,yBACA,4BAAkB,mBAAoB,6BACvCC,MAAKC,WAAEC,QAASC,4BACfD,QAAQE,cAAcC,IAAI,2BAA4BC,SAGlDA,OAAOC,GAAGC,SAASC,QAAQ,wBAAyB,icAEhDC,oBAAsB,eAClBC,SAAW,IAEXC,UAAY,IAAIC,gBAAgBC,OAAOC,SAASC,WAChDJ,UAAUK,IAAI,YACdN,SAAWC,UAAUM,IAAI,iBACtB,GAAIN,UAAUK,IAAI,UACqC,IAAtDH,OAAOC,SAASI,KAAKC,QAAQ,oBAC7BT,SAAWC,UAAUM,IAAI,UACtB,KACCG,KAAOC,SAASC,cAAc,sCAC9BF,KAAM,KACFG,EAAIH,KAAKF,KAAKM,MAAM,YACpBD,IACAb,SAAWa,EAAE,QAMzBV,OAAOY,GAAKZ,OAAOY,EAAEC,KAAOb,OAAOY,EAAEC,IAAIhB,UAAqC,GAAzBG,OAAOY,EAAEC,IAAIhB,WAClEA,SAAWG,OAAOY,EAAEC,IAAIhB,UAGX,MAAbA,SAAkB,KACdiB,OAASN,SAASC,cAAc,wBAChCK,SACAjB,SAAWiB,OAAOC,WAMtBC,MAAQC,OAAOC,MAFP,KAEwB,EAChCC,KAAOF,OAAOG,OAFL,KAEwB,EAGjCC,MAAQ,GACRC,OAAS,OAE4C,IAArDtB,OAAOC,SAASI,KAAKC,QAAQ,qBAA8E,IAAjDN,OAAOC,SAASI,KAAKC,QAAQ,eAAuB,KAE1GiB,WAAaf,SAASgB,eAAe,YAAchB,SAASC,cAAc,sBAC1Ec,aACAF,MAAQE,WAAWR,WAEpB,KAECU,UAAYjB,SAASC,cAAc,uBAAyBD,SAASgB,eAAe,WACpFC,YACAH,OAASG,UAAUV,WAInBW,aAAelB,SAASgB,eAAe,kBAAoBhB,SAASgB,eAAe,qBACnFE,cAAgBA,aAAaX,MAC7BM,MAAQK,aAAaX,UAClB,KAECY,YAAcnB,SAASoB,iBAAiB,uBACxCD,YAAYE,OAAS,UAGjBC,SAAW,CAAC,WAAY,UAAW,OAAQ,iBAAkB,UAAW,OAAQ,QAC3EC,EAAIJ,YAAYE,OAAS,EAAGE,GAAK,EAAGA,IAAK,SAC1CC,KAAOL,YAAYI,GAAGE,YAAYC,OAClCC,UAAYH,KAAKI,cACjBC,MAAO,EACFC,EAAI,EAAGA,EAAIR,SAASD,OAAQS,QACO,IAApCH,UAAU7B,QAAQwB,SAASQ,IAAY,CACvCD,MAAO,WAIXL,MAAQA,OAASV,SAAWe,KAAM,CAClChB,MAAQW,gBAKfX,MAAO,KAEJkB,cAAgB/B,SAASC,cAAc,iBACzBD,SAASC,cAAc,6BACvBD,SAASC,cAAc,oCACrC8B,cAAe,KACXC,MAAQD,cAAcN,YAAYC,OAClCM,QAAUlB,SACVD,MAAQmB,cAQxBC,KAAOzC,OAAOY,GAAKZ,OAAOY,EAAEC,KAAOb,OAAOY,EAAEC,IAAI6B,QAAU1C,OAAOY,EAAEC,IAAI6B,QAAU,IAAM,0DAA4D7C,SAAW,UAAY8C,mBAAmBtB,OAAS,WAAasB,mBAAmBrB,QAAU,WAGpPtB,OAAO4C,KAAKH,IAAK,oBAAqB,4BAAmDtB,IAAM,SAAWH,KAAO,yCAIrHxB,OAAOC,GAAGC,SAASmD,UAAU,mBAAoB,CAC7CC,KAAM,wBACNC,QAAS,sBACTC,SAAUpD,sBAIdJ,OAAOC,GAAGC,SAASuD,YAAY,mBAAoB,CAC/CjB,KAAM,sBACNc,KAAM,wBACNE,SAAUpD,sBAGPP,kBAGJ,CAAC,0BAA2B6D"}