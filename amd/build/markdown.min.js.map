{"version":3,"file":"markdown.min.js","sources":["../src/markdown.js"],"sourcesContent":["/**\n * This file is part of Moodle - http://moodle.org/\n *\n * Moodle is free software: you can redistribute it and/or modify\n * it under the terms of the GNU General Public License as published by\n * the Free Software Foundation, either version 3 of the License, or\n * (at your option) any later version.\n *\n * Moodle is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n * GNU General Public License for more details.\n *\n * You should have received a copy of the GNU General Public License\n * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n */\n\n/**\n * Markdown parsing and rendering for the AI Prompt Generator.\n *\n * @package\n * @copyright  2025 AI4Teachers\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([], function() {\n    /**\n     * Helper to inject newlines before markdown blocks and fix common AI output issues.\n     *\n     * @param {string} text\n     * @returns {string}\n     */\n    const autofixMarkdown = function(text) {\n        if (!text) {\n            return text;\n        }\n        let res = text;\n\n        // 1. Fix clumped numbers like \"cars.2. Machine\" -> \"cars.\\n2. Machine\"\n        res = res.replace(/([.!?])(\\s*)(\\d+\\.\\s+)/g, '$1\\n$3');\n\n        // 2. Fix bold markers that wrap newlines or have spaces inside like \"** Title **\" or \"**Title\\n**\"\n        res = res.replace(/(\\*\\*)(?:\\s*\\n+\\s*|\\s+)/g, '$1'); // Remove space/newline after opening **\n        res = res.replace(/(?:\\s*\\n+\\s*|\\s+)(\\*\\*)/g, '$1'); // Remove space/newline before closing **\n\n        // 3. Fix broken bold markers from AI like \"* *\" -> \"**\"\n        res = res.replace(/\\*\\s+\\*/g, '**');\n\n        // 4. Force newlines before list items or headers if they are clumped with text\n        res = res.replace(/([a-z\\u00C0-\\u00FF0-9.!?])(\\s*)([*\\-+] |\\d+\\. |#{1,6} )/g, '$1\\n$3');\n\n        // 5. Convert plus-sign lists to standard asterisk lists\n        res = res.replace(/^\\s*\\+\\s+/gm, '* ');\n\n        // 4. Existing fixes\n        res = res.replace(/([^\\n])(\\*\\*\\*\\*.*?\\*\\*\\*\\*)/g, '$1\\n\\n$2');\n        res = res.replace(/(\\*\\*\\*\\*.*?\\*\\*\\*\\*)([^\\n])/g, '$1\\n\\n$2');\n        res = res.replace(/(:)(\\*\\*\\*)/g, '$1**\\n* ');\n        res = res.replace(/([^\\n])(\\*\\*\\*)(\\s)/g, '$1**\\n*$3');\n        res = res.replace(/([.?!)])\\s*(\\* )/g, '$1\\n$2');\n        res = res.replace(/([^\\n])(\\*\\*\\*\\*)(?=\\S)/g, '**\\n\\n**');\n        res = res.replace(/([^\\n])(\\*\\*|__)(?=[a-zA-Z0-9\\u00C0-\\u00FF])/g, '$1\\n$2');\n        res = res.replace(/([^\\n])(^|\\s)([*\\-+] )/g, '$1\\n$3');\n        res = res.replace(/([^\\n])(#{1,6} )/g, '$1\\n$2');\n        res = res.replace(/([^\\n])(^|\\s)(\\*\\*\\*|---|___)(\\s|$)/gm, '$1\\n$3');\n        res = res.replace(/([^\\n])(\\s)([IVX]+|[ivx]+)(\\.)/g, '$1\\n$3$4');\n\n        // Clean up excessive newlines\n        res = res.replace(/\\n{3,}/g, '\\n\\n');\n        return res;\n    };\n\n    /**\n     * Process inline elements like images, links, bold, italic.\n     *\n     * @param {string} text\n     * @returns {string}\n     */\n    const processInline = function(text) {\n        if (!text) {\n            return '';\n        }\n        return text\n            .replace(/!\\[(.*?)\\]\\((.*?)\\)/g, '<img src=\"$2\" alt=\"$1\" style=\"max-width:100%;height:auto;\">')\n            .replace(/\\[(.*?)\\]\\((.*?)\\)/g, '<a href=\"$2\" target=\"_blank\" rel=\"noopener noreferrer\">$1</a>')\n            .replace(/\\*\\*\\*\\*(.*?)\\*\\*\\*\\*/g, '<h3>$1</h3>')\n            .replace(/\\*\\*(.*?)\\*\\*/g, '<strong>$1</strong>')\n            .replace(/\\*(.*?)\\*/g, '<em>$1</em>')\n            .replace(/`(.*?)`/g, '<code style=\"background:#eee;padding:2px 4px;border-radius:3px;\">$1</code>');\n    };\n\n    /**\n     * Helper to close an open list.\n     *\n     * @param {string} html Current HTML\n     * @param {string|null} listType Current list type\n     * @returns {string}\n     */\n    const closeList = function(html, listType) {\n        if (!listType) {\n            return html;\n        }\n        return html + (listType === 'ul' ? '</ul>' : '</ol>');\n    };\n\n    /**\n     * Process a single line of Markdown.\n     *\n     * @param {Object} state Current state\n     * @param {string} line The line to process\n     */\n    const processLine = function(state, line) {\n        if (line.trim().startsWith('```')) {\n            if (state.inCodeBlock) {\n                state.inCodeBlock = false;\n                state.html += '</code></pre>';\n            } else {\n                state.html = closeList(state.html, state.listType);\n                state.inList = false;\n                state.listType = null;\n                const style = 'display:block;background:#f4f4f4;padding:10px;border-radius:5px;' +\n                            'overflow-x:auto;font-family:monospace;';\n                state.html += '<pre><code style=\"' + style + '\">';\n                state.inCodeBlock = true;\n            }\n            return;\n        }\n\n        if (state.inCodeBlock) {\n            state.html += line + '\\n';\n            return;\n        }\n\n        const trimmed = line.trim();\n        if (trimmed === '') {\n            state.html = closeList(state.html, state.listType);\n            state.inList = false;\n            state.listType = null;\n            state.html += '<br>';\n            return;\n        }\n\n        const hdrs = [\n            {prefix: '###### ', tag: 'h6'}, {prefix: '##### ', tag: 'h5'},\n            {prefix: '#### ', tag: 'h4'}, {prefix: '### ', tag: 'h3'},\n            {prefix: '## ', tag: 'h2'}, {prefix: '# ', tag: 'h1'}\n        ];\n\n        for (let i = 0; i < hdrs.length; i++) {\n            if (trimmed.startsWith(hdrs[i].prefix)) {\n                state.html = closeList(state.html, state.listType);\n                state.inList = false;\n                state.listType = null;\n                state.html += '<' + hdrs[i].tag + '>' + processInline(trimmed.substring(hdrs[i].prefix.length)) +\n                            '</' + hdrs[i].tag + '>';\n                return;\n            }\n        }\n\n        if (trimmed.match(/^(\\*{3,}|-{3,}|_{3,})$/)) {\n            state.html = closeList(state.html, state.listType);\n            state.inList = false;\n            state.listType = null;\n            state.html += '<hr>';\n            return;\n        }\n\n        if (processListItems(state, trimmed)) {\n            return;\n        }\n\n        if (trimmed.startsWith('> ')) {\n            state.html = closeList(state.html, state.listType);\n            state.inList = false;\n            state.listType = null;\n            const bstyle = 'border-left:4px solid #ccc;padding-left:10px;color:#666;';\n            state.html += '<blockquote style=\"' + bstyle + '\">' + processInline(trimmed.substring(2)) + '</blockquote>';\n        } else {\n            state.html = closeList(state.html, state.listType);\n            state.inList = false;\n            state.listType = null;\n            state.html += '<p>' + processInline(trimmed.replace(/^\\*(?!\\*)\\s*/, '')) + '</p>';\n        }\n    };\n\n    /**\n     * Process list items specifically.\n     *\n     * @param {Object} state\n     * @param {string} trimmed\n     * @returns {boolean}\n     */\n    const processListItems = function(state, trimmed) {\n        let m = trimmed.match(/^([IVX]+)\\.\\s+(.*)/);\n        if (m) {\n            if (!state.inList || state.listType !== 'ol_roman') {\n                state.html = closeList(state.html, state.listType);\n                state.html += '<ol type=\"I\">';\n                state.inList = true;\n                state.listType = 'ol_roman';\n            }\n            state.html += '<li>' + processInline(m[2]) + '</li>';\n            return true;\n        }\n\n        m = trimmed.match(/^[*\\-+]\\s+(.*)/);\n        if (m) {\n            if (!state.inList || state.listType !== 'ul') {\n                state.html = closeList(state.html, state.listType);\n                state.html += '<ul>';\n                state.inList = true;\n                state.listType = 'ul';\n            }\n            state.html += '<li>' + processInline(m[1]) + '</li>';\n            return true;\n        }\n\n        m = trimmed.match(/^\\d+\\.\\s+(.*)/);\n        if (m) {\n            if (!state.inList || state.listType !== 'ol') {\n                state.html = closeList(state.html, state.listType);\n                state.html += '<ol>';\n                state.inList = true;\n                state.listType = 'ol';\n            }\n            state.html += '<li>' + processInline(m[1]) + '</li>';\n            return true;\n        }\n        return false;\n    };\n\n    /**\n     * Render Markdown to HTML.\n     *\n     * @param {string} md\n     * @returns {string}\n     */\n    const renderMarkdown = function(md) {\n        if (!md) {\n            return '';\n        }\n        const text = autofixMarkdown(md).replace(/</g, '&lt;').replace(/>/g, '&gt;');\n        const lines = text.split(/\\r?\\n/);\n        const state = {\n            html: '',\n            inList: false,\n            inCodeBlock: false,\n            listType: null\n        };\n\n        lines.forEach(function(line) {\n            processLine(state, line);\n        });\n\n        state.html = closeList(state.html, state.listType);\n        return state.html;\n    };\n\n    /**\n     * Clean markdown for plain text view.\n     *\n     * @param {string} md\n     * @returns {string}\n     */\n    const renderText = function(md) {\n        if (!md) {\n            return '';\n        }\n        var txt = autofixMarkdown(md);\n        txt = txt.replace(/\\*\\*\\*\\*(.*?)\\*\\*\\*\\*/g, '$1');\n        var prev = '';\n        while (txt !== prev) {\n            prev = txt;\n            txt = txt.replace(/(\\*\\*|__)(.*?)\\1/g, '$2').replace(/(\\*|_)(.*?)\\1/g, '$2');\n        }\n        txt = txt.replace(/^#+\\s+(.*)$/gm, '\\n$1\\n' + '-'.repeat(20));\n        txt = txt.replace(/^[*\\-+]\\s+/gm, '- ');\n        txt = txt.replace(/```/g, '');\n        txt = txt.replace(/^- \\s*\\*+/gm, '');\n        txt = txt.replace(/\\n{3,}/g, '\\n\\n');\n        return txt.trim();\n    };\n\n    return {\n        autofixMarkdown: autofixMarkdown,\n        renderMarkdown: renderMarkdown,\n        renderText: renderText\n    };\n});\n"],"names":["define","autofixMarkdown","text","res","replace","processInline","closeList","html","listType","processListItems","state","trimmed","m","match","inList","renderMarkdown","md","lines","split","inCodeBlock","forEach","line","trim","startsWith","style","hdrs","prefix","tag","i","length","substring","bstyle","processLine","renderText","txt","prev","repeat"],"mappings":"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"}